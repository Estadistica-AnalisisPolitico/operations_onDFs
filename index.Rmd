<center><img src="https://github.com/Estadistica-AnalisisPolitico/operations_onDFs/blob/main/Logo2025.png?raw=true" width="700"/></center>

Profesor:[Dr. José Manuel MAGALLANES REYES, Ph.D](http://www.pucp.edu.pe/profesor/jose-manuel-magallanes/" target="_blank) <br>

-   Profesor Principal del Departamento de Ciencias Sociales, Sección de Ciencia Política y Gobierno.

-   [Oficina 223](https://goo.gl/maps/xuGeG6o9di1i1y5m6) - Edificio CISEPA / ECONOMIA / CCSS
-   Telefono: (51) 1 - 6262000 anexo 4302
-   Correo Electrónico: [jmagallanes\@pucp.edu.pe](mailto:jmagallanes@pucp.edu.pe)


Operations on Data Frames

# Aggregation

Let's bring some data of COVID from Brazil:

```{r}
rm(list = ls())
linkCovid='https://github.com/Estadistica-AnalisisPolitico/operations_onDFs/raw/refs/heads/main/data/BrasilCovid.rds'
dataCovid=readRDS(url(linkCovid))
```



Now, check the data available:

```{r}
str(dataCovid)
```

Let's keep complete data by "ESTADO":

```{r}
dataCovid=dataCovid[dataCovid$estado!="",]
```

Let's keep some columns:

```{r}

toSelect=c('regiao', 'estado', 'municipio','data', 'semanaEpi','casosNovos', 'obitosNovos','day','year','month')
covid=dataCovid[,toSelect]

head(covid)
```


Let's find out about years available:

```{r}
unique(covid$year)
```

```{r}
unique(covid$month)
```

So, we have data from January to July 2022. Let's find out: **count of new positive cases per month**:

```{r}

for (month in unique(covid$month)) {
    print(paste(month,sum(covid$casosNovos[covid$month==month])))}
```

We use **aggregation** to simplify the previous steps:

```{r}
# sum of cases by month
casesSumByMonth=aggregate(data=covid,casosNovos~month,sum)
casesSumByMonth
```

Notice the structure:
```{r}
is.data.frame(casesSumByMonth)
```


**AGGREGATING** capabilities allow us to produce useful output with few code:

-   **The groupings**:

In the last example, *month* was the **grouping** variable. We can have more than one:

```{r}
# sum of cases by estado and month
theModel=casosNovos~estado + month
theFun=sum
casesSumByStateAndMonth=aggregate(data=covid,
                                  theModel,
                                  theFun)
casesSumByStateAndMonth
```

-   **The function to apply**:

We can have more than one function:

```{r}
# sum and mean of cases by estado and week
theModel=casosNovos~estado + semanaEpi
theFun=function(x) c(mean = mean(x), sum = sum(x) ) 
casesSumAndMeanByStateAndWeek=aggregate(data=covid,
                                        theModel,
                                        theFun)

# can you see?
head(casesSumAndMeanByStateAndWeek,30)
```
```{r}
is.data.frame(casesSumAndMeanByStateAndWeek)
```

So, turn the aggregation explicitly into a dataframe:

```{r}
casesSumAndMeanByStateAndWeek=do.call(data.frame,
                                      aggregate(data=covid,
                                                theModel,
                                                theFun))
head(casesSumAndMeanByStateAndWeek,30)
```

-   **The variables transformed**:

We can apply the function to more than one variable:

```{r}
# sum of cases and deaths by estado
theModel=cbind(casosNovos,obitosNovos)~estado
theFun=sum
CasesAndDeathsByState=aggregate(data=covid,
                                theModel,
                                theFun)

head(CasesAndDeathsByState,30)
```

-   Function **according** to variable

The function can vary according to variable. In this case, using **dplyr** is needed:

```{r, warning=FALSE}
library(dplyr)
covid |>
  group_by(month) |>
  summarize(casosNovos_VAR = var(casosNovos),
            casosNovos_SD = sd(casosNovos),
            obitosNovos_Median = median(obitosNovos),
            obitosNovos_Mean = mean(obitosNovos))
```
